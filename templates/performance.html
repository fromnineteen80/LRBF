{% extends "base.html" %}
{% block title %}Performance - Railyard Markets{% endblock %}
{% block page_title %}Performance{% endblock %}
{% block content %}

<!-- Key Performance Indicators -->
<div class="grid grid-cols-4" style="gap: 16px; margin-bottom: 24px;">
    <md-elevated-card>
        <div style="padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">trending_up</span>
                <span class="label-large" style="color: var(--md-sys-color-on-surface-variant);">Total Return</span>
            </div>
            <h2 id="totalReturn" class="display-small" style="margin: 0; color: var(--md-sys-color-on-surface);">--</h2>
            <p id="totalReturnChange" class="body-small" style="margin-top: 8px; color: var(--md-sys-color-on-surface-variant);">--</p>
        </div>
    </md-elevated-card>
    
    <md-elevated-card>
        <div style="padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">percent</span>
                <span class="label-large" style="color: var(--md-sys-color-on-surface-variant);">Win Rate</span>
            </div>
            <h2 id="winRate" class="display-small" style="margin: 0; color: var(--md-sys-color-on-surface);">--</h2>
            <p id="winRateChange" class="body-small" style="margin-top: 8px; color: var(--md-sys-color-on-surface-variant);">--</p>
        </div>
    </md-elevated-card>
    
    <md-elevated-card>
        <div style="padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">speed</span>
                <span class="label-large" style="color: var(--md-sys-color-on-surface-variant);">Sharpe Ratio</span>
            </div>
            <h2 id="sharpeRatio" class="display-small" style="margin: 0; color: var(--md-sys-color-on-surface);">--</h2>
            <p id="sharpeRatioChange" class="body-small" style="margin-top: 8px; color: var(--md-sys-color-on-surface-variant);">--</p>
        </div>
    </md-elevated-card>
    
    <md-elevated-card>
        <div style="padding: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">waterfall_chart</span>
                <span class="label-large" style="color: var(--md-sys-color-on-surface-variant);">Max Drawdown</span>
            </div>
            <h2 id="maxDrawdown" class="display-small" style="margin: 0; color: var(--md-sys-color-on-surface);">--</h2>
            <p id="maxDrawdownChange" class="body-small" style="margin-top: 8px; color: var(--md-sys-color-on-surface-variant);">--</p>
        </div>
    </md-elevated-card>
</div>

<!-- Recommendations Card -->
<md-elevated-card style="margin-bottom: 24px;">
    <div style="padding: 16px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">lightbulb</span>
            <h3 class="title-large" style="margin: 0;">Recommendations</h3>
        </div>
    </div>
    <div style="padding: 24px;">
        <div id="recommendations">
            <md-circular-progress indeterminate></md-circular-progress>
        </div>
    </div>
</md-elevated-card>

<!-- Performance Trends -->
<md-elevated-card>
    <div style="padding: 16px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">insights</span>
            <h3 class="title-large" style="margin: 0;">Performance Trends</h3>
        </div>
    </div>
    <div style="padding: 24px;">
        <canvas id="performanceChart" height="80"></canvas>
    </div>
</md-elevated-card>

{% endblock %}

{% block scripts %}
<script>
async function loadPerformance() {
    try {
        // Load performance data
        const data = await apiCall('/api/eod-data');
        
        // Update KPI cards
        document.getElementById('totalReturn').textContent = data.total_return || 'N/A';
        document.getElementById('totalReturnChange').textContent = data.total_return_change || 'Since inception';
        
        document.getElementById('winRate').textContent = (data.win_rate || 0) + '%';
        document.getElementById('winRateChange').textContent = data.win_rate_change || 'All time';
        
        document.getElementById('sharpeRatio').textContent = (data.sharpe_ratio || 0).toFixed(2);
        document.getElementById('sharpeRatioChange').textContent = data.sharpe_change || 'Target: >2.0';
        
        document.getElementById('maxDrawdown').textContent = (data.max_drawdown || 0).toFixed(2) + '%';
        document.getElementById('maxDrawdownChange').textContent = data.drawdown_change || 'All time';
        
        // Generate recommendations
        const recommendations = generateRecommendations(data);
        document.getElementById('recommendations').innerHTML = recommendations;
        
        // Create performance trend chart
        createPerformanceChart(data);
        
    } catch (error) {
        console.error('Failed to load performance:', error);
        document.getElementById('recommendations').innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <span class="material-symbols-outlined" style="color: var(--md-sys-color-error); font-size: 48px;">error</span>
                <p class="body-medium" style="margin-top: 12px; color: var(--md-sys-color-error);">Failed to load performance data</p>
            </div>
        `;
    }
}

function generateRecommendations(data) {
    const recommendations = [];
    
    // Win rate analysis
    if (data.win_rate < 60) {
        recommendations.push({
            type: 'warning',
            icon: 'warning',
            title: 'Win Rate Below Target',
            message: `Current win rate of ${data.win_rate}% is below the 65% target. Consider reviewing entry conditions and risk management.`
        });
    } else if (data.win_rate >= 65) {
        recommendations.push({
            type: 'success',
            icon: 'check_circle',
            title: 'Win Rate On Target',
            message: `Excellent win rate of ${data.win_rate}%. Strategy is performing as expected.`
        });
    }
    
    // Sharpe ratio analysis
    if (data.sharpe_ratio < 2.0) {
        recommendations.push({
            type: 'warning',
            icon: 'trending_down',
            title: 'Sharpe Ratio Below Target',
            message: 'Risk-adjusted returns could be improved. Consider reducing position sizes or tightening stop losses.'
        });
    } else {
        recommendations.push({
            type: 'success',
            icon: 'trending_up',
            title: 'Strong Risk-Adjusted Returns',
            message: `Sharpe ratio of ${data.sharpe_ratio.toFixed(2)} indicates excellent risk-adjusted performance.`
        });
    }
    
    // Drawdown analysis
    if (Math.abs(data.max_drawdown) > 5) {
        recommendations.push({
            type: 'error',
            icon: 'report',
            title: 'High Drawdown Detected',
            message: `Maximum drawdown of ${data.max_drawdown.toFixed(2)}% exceeds comfort zone. Review recent trades and risk limits.`
        });
    }
    
    // Default recommendation if none triggered
    if (recommendations.length === 0) {
        recommendations.push({
            type: 'info',
            icon: 'info',
            title: 'All Systems Normal',
            message: 'Fund performance is within expected parameters. Continue monitoring daily metrics.'
        });
    }
    
    return recommendations.map(rec => `
        <div style="display: flex; gap: 16px; padding: 16px; background-color: var(--md-sys-color-surface-variant); border-radius: 12px; margin-bottom: 12px;">
            <span class="material-symbols-outlined" style="color: var(--md-sys-color-${rec.type === 'success' ? 'primary' : rec.type}); font-size: 32px;">${rec.icon}</span>
            <div style="flex: 1;">
                <h4 class="title-medium" style="margin: 0 0 8px 0;">${rec.title}</h4>
                <p class="body-medium" style="margin: 0; color: var(--md-sys-color-on-surface-variant);">${rec.message}</p>
            </div>
        </div>
    `).join('');
}

function createPerformanceChart(data) {
    const ctx = document.getElementById('performanceChart');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [
                {
                    label: 'Daily ROI',
                    data: [3.2, 4.1, 3.8, 4.5],
                    borderColor: '#7A8261',
                    backgroundColor: 'rgba(122, 130, 97, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Target',
                    data: [3.5, 3.5, 3.5, 3.5],
                    borderColor: '#E7C36D',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    tension: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'ROI %'
                    }
                }
            }
        }
    });
}

loadPerformance();
</script>
{% endblock %}
