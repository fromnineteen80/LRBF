{% extends "base.html" %}

{% block title %}Delete Account - Railyard Markets{% endblock %}
{% block page_title %}Delete Account{% endblock %}

{% block content %}
<div class="content-wrapper" style="max-width: 800px; margin: 0 auto; padding: 24px;">
    
    <!-- Warning Card -->
    <md-elevated-card class="warning-card" style="margin-bottom: 24px;">
        <div style="padding: 32px;">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px;">
                <span class="material-symbols-outlined" style="font-size: 48px; color: var(--md-sys-color-error);">warning</span>
                <div>
                    <h2 style="margin: 0; color: var(--md-sys-color-error); font-size: 24px;">Account Deletion Warning</h2>
                    <p style="margin: 8px 0 0; color: var(--md-sys-color-on-surface-variant); font-size: 14px;">
                        This action is permanent and cannot be undone
                    </p>
                </div>
            </div>
            
            <p style="margin: 0 0 16px; line-height: 1.6;">
                You are about to delete your co-founder account from The Luggage Room Boys Fund. 
                Please review the following information carefully before proceeding.
            </p>
            
            <div style="background: var(--md-sys-color-error-container); border-radius: 12px; padding: 16px; margin-top: 16px;">
                <ul style="margin: 0; padding-left: 20px; color: var(--md-sys-color-on-error-container);">
                    <li>Your account will be permanently disabled</li>
                    <li>You will lose access to all fund data and reports</li>
                    <li>Your ownership percentage will be redistributed among remaining co-founders</li>
                    <li>All other co-founders will be notified of your departure</li>
                    <li>You will receive your proportional share of the current fund value</li>
                </ul>
            </div>
        </div>
    </md-elevated-card>
    
    <!-- Account Summary Card -->
    <md-elevated-card style="margin-bottom: 24px;">
        <div style="padding: 32px;">
            <h3 style="margin: 0 0 24px; display: flex; align-items: center; gap: 8px;">
                <span class="material-symbols-outlined">account_circle</span>
                Your Account Summary
            </h3>
            
            <div class="summary-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px;">
                <div class="summary-item">
                    <div style="color: var(--md-sys-color-on-surface-variant); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Name</div>
                    <div style="font-size: 18px; font-weight: 500;">{{ user.first_name }} {{ user.last_name }}</div>
                </div>
                
                <div class="summary-item">
                    <div style="color: var(--md-sys-color-on-surface-variant); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Username</div>
                    <div style="font-size: 18px; font-weight: 500;">{{ user.username }}</div>
                </div>
                
                <div class="summary-item">
                    <div style="color: var(--md-sys-color-on-surface-variant); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Member Since</div>
                    <div style="font-size: 18px; font-weight: 500;">{{ user.created_at|date }}</div>
                </div>
                
                <div class="summary-item">
                    <div style="color: var(--md-sys-color-on-surface-variant); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Your Contribution</div>
                    <div style="font-size: 18px; font-weight: 500;">${{ "{:,.2f}".format(user.fund_contribution) }}</div>
                </div>
                
                <div class="summary-item">
                    <div style="color: var(--md-sys-color-on-surface-variant); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Ownership</div>
                    <div style="font-size: 18px; font-weight: 500; color: var(--md-sys-color-primary);">{{ user.ownership_pct }}%</div>
                </div>
                
                <div class="summary-item">
                    <div style="color: var(--md-sys-color-on-surface-variant); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Current Fund Value</div>
                    <div style="font-size: 18px; font-weight: 500;">${{ "{:,.2f}".format(current_fund_value) }}</div>
                </div>
            </div>
        </div>
    </md-elevated-card>
    
    <!-- Payout Calculation Card -->
    <md-elevated-card style="margin-bottom: 24px; background: var(--md-sys-color-tertiary-container);">
        <div style="padding: 32px;">
            <h3 style="margin: 0 0 24px; display: flex; align-items: center; gap: 8px; color: var(--md-sys-color-on-tertiary-container);">
                <span class="material-symbols-outlined">payments</span>
                Your Payout Calculation
            </h3>
            
            <div style="background: var(--md-sys-color-surface); border-radius: 12px; padding: 24px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="color: var(--md-sys-color-on-surface-variant);">Current Fund Value:</span>
                    <span style="font-size: 18px; font-weight: 500;">${{ "{:,.2f}".format(current_fund_value) }}</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="color: var(--md-sys-color-on-surface-variant);">Your Ownership:</span>
                    <span style="font-size: 18px; font-weight: 500;">{{ user.ownership_pct }}%</span>
                </div>
                
                <md-divider style="margin: 16px 0;"></md-divider>
                
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 500; font-size: 18px;">Your Payout:</span>
                    <span style="font-size: 28px; font-weight: 700; color: var(--md-sys-color-primary);">
                        ${{ "{:,.2f}".format(payout_amount) }}
                    </span>
                </div>
            </div>
            
            <p style="margin: 0; font-size: 14px; color: var(--md-sys-color-on-tertiary-container); opacity: 0.8;">
                This amount represents your {{ user.ownership_pct }}% share of the current fund value.
            </p>
        </div>
    </md-elevated-card>
    
    <!-- Payout Instructions Card -->
    <md-elevated-card style="margin-bottom: 32px;">
        <div style="padding: 32px;">
            <h3 style="margin: 0 0 24px; display: flex; align-items: center; gap: 8px;">
                <span class="material-symbols-outlined">info</span>
                Withdrawal Process
            </h3>
            
            <div style="line-height: 1.8; color: var(--md-sys-color-on-surface-variant);">
                <p><strong>After confirming account deletion:</strong></p>
                
                <ol style="margin: 16px 0; padding-left: 24px;">
                    <li style="margin-bottom: 12px;">
                        <strong>Immediate Actions:</strong>
                        <ul style="margin-top: 8px;">
                            <li>Your account will be deactivated immediately</li>
                            <li>All co-founders will receive email notification</li>
                            <li>Your deletion request will be logged in the system</li>
                        </ul>
                    </li>
                    
                    <li style="margin-bottom: 12px;">
                        <strong>Liquidation Process (1-5 Business Days):</strong>
                        <ul style="margin-top: 8px;">
                            <li>Remaining co-founders will close your proportional positions in IBKR</li>
                            <li>Positions will be liquidated at current market prices</li>
                            <li>Settlement period applies per standard brokerage rules</li>
                        </ul>
                    </li>
                    
                    <li style="margin-bottom: 12px;">
                        <strong>Payout Transfer (5-7 Business Days):</strong>
                        <ul style="margin-top: 8px;">
                            <li>Funds will be transferred from IBKR to your personal bank account</li>
                            <li>You will provide wire transfer or ACH details via email</li>
                            <li>A detailed transaction statement will be provided for tax purposes</li>
                        </ul>
                    </li>
                    
                    <li>
                        <strong>Tax Considerations:</strong>
                        <ul style="margin-top: 8px;">
                            <li>You will receive a K-1 form for partnership distributions</li>
                            <li>Capital gains/losses will be calculated based on your cost basis</li>
                            <li>Consult your tax advisor regarding reporting requirements</li>
                        </ul>
                    </li>
                </ol>
                
                <div style="background: var(--md-sys-color-primary-container); border-radius: 8px; padding: 16px; margin-top: 24px;">
                    <p style="margin: 0; color: var(--md-sys-color-on-primary-container); font-weight: 500;">
                        <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 8px;">schedule</span>
                        Total process time: 10-15 business days
                    </p>
                </div>
            </div>
        </div>
    </md-elevated-card>
    
    <!-- Confirmation Section -->
    <div style="background: var(--md-sys-color-surface); border: 2px solid var(--md-sys-color-error); border-radius: 16px; padding: 32px;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
            <md-checkbox id="confirmCheckbox"></md-checkbox>
            <label for="confirmCheckbox" style="cursor: pointer; user-select: none;">
                I understand that this action is permanent and irreversible. I agree to the withdrawal process and timeline outlined above.
            </label>
        </div>
        
        <div style="display: flex; gap: 16px;">
            <md-filled-button onclick="window.location.href='{{ url_for('settings') }}'" style="flex: 1;">
                <span slot="icon" class="material-symbols-outlined">arrow_back</span>
                Cancel
            </md-filled-button>
            
            <md-filled-button id="deleteButton" disabled style="flex: 1; --md-filled-button-container-color: var(--md-sys-color-error);">
                <span slot="icon" class="material-symbols-outlined">delete_forever</span>
                Confirm Deletion
            </md-filled-button>
        </div>
    </div>
    
    <div id="errorMessage" style="display: none; margin-top: 24px; padding: 16px; background: var(--md-sys-color-error-container); color: var(--md-sys-color-on-error-container); border-radius: 8px;"></div>
</div>

<script>
    // Enable delete button when checkbox is checked
    const checkbox = document.getElementById('confirmCheckbox');
    const deleteButton = document.getElementById('deleteButton');
    
    checkbox.addEventListener('change', () => {
        deleteButton.disabled = !checkbox.checked;
    });
    
    // Handle delete confirmation
    deleteButton.addEventListener('click', async () => {
        if (!checkbox.checked) return;
        
        // Double confirmation
        const confirmed = confirm(
            'FINAL CONFIRMATION\n\n' +
            'This is your last chance to cancel.\n\n' +
            'Are you absolutely sure you want to delete your account and withdraw your funds?\n\n' +
            'Click OK to proceed or Cancel to go back.'
        );
        
        if (!confirmed) return;
        
        try {
            const response = await fetch('/api/auth/delete-account', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Show success message and redirect to logout
                alert('Account deletion request submitted successfully. You will be logged out now.');
                window.location.href = '/logout';
            } else {
                showError(data.error || 'Failed to delete account');
            }
        } catch (error) {
            showError('Network error. Please try again.');
            console.error('Delete error:', error);
        }
    });
    
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        
        // Scroll to error
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
</script>

<style>
    .warning-card {
        border-left: 4px solid var(--md-sys-color-error);
    }
    
    .summary-item {
        padding: 16px;
        background: var(--md-sys-color-surface-variant);
        border-radius: 8px;
    }
    
    md-checkbox {
        --md-checkbox-selected-container-color: var(--md-sys-color-error);
        --md-checkbox-selected-hover-container-color: var(--md-sys-color-error);
        --md-checkbox-selected-focus-container-color: var(--md-sys-color-error);
        --md-checkbox-selected-pressed-container-color: var(--md-sys-color-error);
    }
</style>
{% endblock %}
